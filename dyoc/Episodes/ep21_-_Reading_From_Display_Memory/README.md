# Design Your Own Computer
# Episode 21 : "Reading From Display Memory"

Welcome to "Design Your Own Computer".  In this episode
we'll make it possible for the CPU to read from the character
and colour memories. This is needed in order to support scrolling
of the screen, when the text reaches the bottom of the screen.

To do this we need to introduce two new signals to the system:
* mem\_wait
* cpu\_rden

## mem\_wait
The FPGA has built-in support for dual port memory, but alas, it looks like we
need three ports. That is because we have already used two ports for CPU write
and VGA read. The CPU read is supposed to happen on the *falling* clock edge,
which requires a third memory port. This is not possible, so instead we'll
revert to having the CPU read on the rising clock edge. This, however, inserts
a delay of one clock cycle each time the CPU performs a memory read, but only
if it is the character and colour memories.

To handle this extra address-dependent delay, we'll introduce a new mem\_wait
signal generated by the memory controller. The wait signal to the CPU,
cpu\_wait is then a logical OR of the previous signal sys\_wait and the new
signal mem\_wait, see lines 110-111 of comp.vhd . This way the CPU will only
proceed when the data from the memory is avaiable.

The mem\_wait signal is generated in lines 80-94 of mem/mem.vhd. Line 84 is the
main line, where CPU reads from either character or colour memories are to be
delayed. The remaining lines, 86-94 ensure that the mem\_wait signal is only
asserted for one clock cycle.

## cpu\_rden
The memory controller needs to know whether the CPU is performing a read or a
write (or possibly even no memory transaction at all). The CPU must therefore
provide a new signal cpu\_rden. This is because the mem\_wait signal should
not be asserted during a memory write cycle.

The cpu\_rden signal is determined in line 446 of cpu/datapath.vhd.  This
basically states that any memory transfer that is not a write must be a read.
The additional signal mem indicates a memory transfer, and is evaluated in
lines 407-420 of cpu/datapath.vhd.

## Other modifications
One major reason for adding read support from display memory, is to
allow screen scrolling. This is done in lib/write.c in lines 45-56.

And that's it! Moving on, we need a few more things, before we're ready to
add keyboard support. Stay tuned ...

